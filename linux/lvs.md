## LVS 

https://mp.weixin.qq.com/s/Da_NuCJu2rDdZrMNEpbqPg



lvs 的全称是 linux virtual server 的简称。

nginx 的负载发生在应用层，它会与客户端和服务端各自建立一个连接 ，这就比较消耗资源。

lvs 相对 nginx，它工作在  4 层，不需要这两个连接，相反它基本就是做转发。它有多种模式，这里整理两种。

### NAT 模式 

NAT 模式下，lvs 每次收到客户端的请求，会按照一定的算法，修改相应的报文头，然后转发给相应的后端服务；后端服务处理完毕后，会将响应结果传给  lvs，lvs 再将报文头修改后，返回给客户端。

这里有两个问题要注意：

第一，为什么要修改报文头，因为传输层是 4 元组识别一个连接的。因此返回给客户端的响应必须由准确的头，客户端才能准确识别出来；

第二，客户端一个请求可能会很长导致分片，因此 lvs 需要记录一个请求被转发给了哪个后端服务，否则会出现大量问题；



### DR 模式

NAT 模式的一个问题是，所有请求和响应都走了 lvs，响应能否不走  lvs？

DR 模式的全程是 direct router，它就是用了这样的想法；DR 模式下，响应会直接通过交换机和网关返回给客户端。

为了达到这样的效果，需要给后端服务设置与 lvs 相同的虚拟地址，而且这个地址在后端服务上，不能响应 arp 请求，以保证这个地址正常只被 lvs 使用；然后每个后端服务发送响应时，又需要通过这个虚拟地址将报文通过网关直接发送出去。所以整个过程比较复杂的就在于，网络结构会复杂一些。